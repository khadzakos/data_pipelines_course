Отчёт по экспериментам Spark-оптимизации

1. **Broadcast vs Shuffle join**

Сравнивались обычный shuffle join и broadcast join при джойне orders (2M строк) с маленькой таблицей countries (200 строк). Baseline (shuffle) занял 1.16 с, broadcast — 0.12 с, то есть ускорение примерно в 9.4 раза. Shuffle read/write в baseline были минимальными (472 B), но сам факт шффла и лишних стадий делал выполнение заметно дольше; broadcast убрал шффл и сократил время до минимума.
Вывод: Для маленькой правой таблицы broadcast join даёт сильный выигрыш по времени при том же результате; его стоит использовать по умолчанию, когда размер правой таблицы позволяет.

2. **Skew и Salting**

Тест на данных с сильным перекосом по ключу (90% строк — один «горячий» ключ): baseline — обычный groupBy("key").agg(count), salted — разбиение ключа на соли, частичная агрегация и слияние. Baseline: 0.54 с, salted: 0.32 с (~1.7× быстрее). У salted больше shuffle (316 KB против 159 KB) и тасков (104 vs 77), но нагрузка распределяется по партициям равномернее, поэтому один «долгий» таск не тянет всё время вверх.
Вывод: Salting эффективно борется со skew: wall-clock время снижается за счёт выравнивания нагрузки по партициям, несмотря на рост объёма шффла и числа тасков.

3. **Repartition и Coalesce**

Проверялось влияние числа партиций на groupBy при ~1M строк. Baseline (8 партиций): 0.22 с. При явном repartition(p) время росло с ростом p: 2 → 0.87 с, 8 → 0.22 с, 16 → 0.29 с, 50 → 0.57 с, 100 → 1.08 с, 200 → 1.70 с, 500 → 4.23 с, 1000 → 7.81 с. Shuffle read/write и число тасков монотонно увеличивались. Coalesce(2) и coalesce(4) дали 0.12 с и 0.07 с — меньше партиций и меньше накладных расходов на шффл в этом сценарии.
Вывод: Для данного объёма данных «родные» 8 партиций оказались близки к оптимуму; увеличение числа партиций (repartition) только ухудшало время из-за роста шффла и числа тасков. Уменьшение партиций через coalesce ускорило выполнение, когда партиций изначально было больше, чем нужно.

**Общий вывод**

Все три приёма (broadcast для маленьких таблиц, salting при skew, аккуратное управление числом партиций) в экспериментах дали ожидаемый эффект: broadcast — сильное ускорение джойна, salting — снижение времени при перекошенных ключах, а выбор числа партиций критичен — избыточное разбиение увеличивает шффл и время. В продакшене стоит настраивать партиционирование и использовать broadcast/salting в зависимости от размера данных и распределения ключей.